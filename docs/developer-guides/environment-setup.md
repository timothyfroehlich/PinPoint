# PinPoint Environment Setup Guide

**Simplified 3-step environment setup using native Vercel tooling**

## Quick Setup

The modern PinPoint environment uses Vercel as the single source of truth for environment variables, eliminating the need for manual file copying and environment conflicts.

### Prerequisites

- **[Vercel CLI](https://vercel.com/cli)** - `npm install -g vercel`
- **[Supabase CLI](https://supabase.com/docs/guides/cli)** - `brew install supabase/tap/supabase`

### 3-Step Setup Process

```bash
# 1. Clone and install dependencies
git clone https://github.com/timothyfroehlich/PinPoint.git
cd PinPoint
npm install

# 2. Connect to Vercel and pull environment variables
vercel link --project pin-point
npm run env:pull  # Pulls .env.local from Vercel Development environment

# 3. Start development stack
supabase start  # Start local Supabase instance
npm run db:reset:local:sb  # Initialize database with schema and seed data
npm run dev  # Start development server at http://localhost:49200
```

That's it! No manual environment file copying needed.

## Environment Architecture

### File Structure

```
PinPoint/
â”œâ”€â”€ .env                    # Safe defaults (committed to repo)
â”œâ”€â”€ .env.local             # Development secrets (generated by vercel)
â””â”€â”€ .gitignore             # .env.local is git-ignored
```

### Environment Sources

| Environment | Variable Source | Use Case |
|-------------|----------------|----------|
| **Development** | `.env.local` (pulled from Vercel Development) | Local coding with `npm run dev` |
| **Preview** | Vercel Preview environment | Staging, PR reviews |
| **Production** | Vercel Production environment | Live user application |

### What Goes Where

**`.env` (committed, safe defaults):**
```bash
PORT="49200"
IMAGE_STORAGE_PROVIDER="local"  
OPDB_API_URL="https://opdb.org/api"
DEFAULT_ORG_SUBDOMAIN="apc"
```

**`.env.local` (generated by `npm run env:pull`, secrets):**
```bash
# Created by Vercel CLI - Contains secrets for local development
DATABASE_URL="postgresql://postgres:postgres@localhost:54322/postgres"
NEXT_PUBLIC_SUPABASE_URL="http://localhost:54321"
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY="eyJ..."  # Local Supabase anon key
SUPABASE_SECRET_KEY="eyJ..."                    # Local Supabase service role key
OPDB_API_KEY="your-opdb-api-key"               # External API key
# ... other secrets
```

## Commands Reference

### Environment Management
- `npm run env:pull` - Pull latest development environment from Vercel
- `npm run env:pull -- --environment=preview` - Pull preview environment (for testing)

### Database Commands  
- `npm run db:reset:local:sb` - Fresh database with schema and seed data
- `npm run db:push:local` - Push schema changes without reset
- `npm run db:reset:preview` - Reset with preview environment (pulls preview vars first)

### Development Workflow
- `npm run dev` - Start development server
- `npm run check` - Run all quality checks (typecheck, lint, format, audit)
- `npm run validate` - Full validation including tests

## Benefits of This Approach

### âœ… Advantages
- **No file copying**: Single command pulls all secrets
- **No environment conflicts**: Clear precedence (.env.local > .env)
- **Version control safe**: Only safe defaults committed
- **Team consistency**: Everyone gets same development environment
- **Environment switching**: Easy preview testing with `--environment=preview`
- **Native tooling**: Uses Vercel CLI instead of workarounds

### ðŸš« What We Eliminated
- ~~Manual `.env.example` copying~~
- ~~Multiple conflicting .env files~~
- ~~File precedence confusion~~
- ~~dotenv-cli dependency~~
- ~~Environment variable priority issues~~

## Troubleshooting

### Common Issues

**Environment variables not loading:**
```bash
# Re-pull from Vercel
npm run env:pull
```

**Database connection issues:**
```bash
# Ensure Supabase is running
supabase status
# If not running:
supabase start
```

**Port conflicts:**
```bash
# Check if ports are in use
lsof -i :49200  # Next.js dev server
lsof -i :54321  # Supabase API
lsof -i :54322  # Supabase DB
```

**Wrong environment variables:**
```bash
# Check current environment
cat .env.local

# Pull specific environment
npm run env:pull -- --environment=preview --yes
```

### Recovery Commands

```bash
# Full reset
supabase stop
rm -f .env.local
npm run env:pull
supabase start
npm run db:reset:local:sb
npm run dev
```

## Migration Notes

If you're migrating from the old system with multiple `.env.*` files:

1. **Delete old files**: Remove `.env.development`, `.env.development.local`, etc.
2. **Run setup**: Follow the 3-step process above
3. **Verify**: Check that `npm run dev` works correctly

The new system is simpler and more reliable than the previous multi-file approach.