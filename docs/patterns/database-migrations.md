# Database Migrations Pattern

## Overview

PinPoint uses **Drizzle ORM** for schema definition and migrations, plus a **separate exported schema** for PGlite tests.

- **Source of truth**: `src/server/db/schema.ts`
- **Migrations folder**: `drizzle/` (generated by Drizzle Kit)
- **Test schema**: `src/test/setup/schema.sql` (generated with `drizzle-kit export`)

This pattern keeps production/preview databases in sync via migrations while ensuring tests always run against a known-good schema snapshot.

## Commands

- **Generate migrations from schema**

  ```bash
  pnpm run db:generate -- --name <change-name>
  ```

- **Apply migrations to the current database**

  ```bash
  pnpm run db:migrate
  ```

- **Regenerate test schema for PGlite**

  ```bash
  pnpm run test:_generate-schema
  ```

## Where Itâ€™s Used

- Local development (`db:migrate` after editing `schema.ts`)
- CI reset scripts (`scripts/supa-ci.sh`, `scripts/db-reset-preview.sh`)
- Test setup (`src/test/setup/schema.sql` is regenerated from the same schema)

## Guidelines

- Always edit `src/server/db/schema.ts` first.
- Generate a migration with a descriptive name (e.g., `add-notifications-table`).
- Run `pnpm run db:migrate` locally and in preview/prod via scripts.
- After structural changes, regenerate the test schema and commit both:

  ```bash
  pnpm run test:_generate-schema
  git add src/server/db/schema.ts drizzle/ src/test/setup/schema.sql
  ```
