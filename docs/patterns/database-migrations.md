# Database Migrations Pattern

## Overview

PinPoint uses **Drizzle ORM** for schema definition and migrations, plus a **separate exported schema** for PGlite tests.

- **Source of truth**: `src/server/db/schema.ts`
- **Migrations folder**: `drizzle/` (generated by Drizzle Kit)
- **Test schema**: `src/test/setup/schema.sql` (generated with `drizzle-kit export`)

This pattern keeps production/preview databases in sync via migrations while ensuring tests always run against a known-good schema snapshot.

## Commands

- **Generate migrations from schema**

  ```bash
  pnpm run db:generate -- --name <change-name>
  ```

- **Apply migrations to the current database**

  ```bash
  pnpm run db:migrate
  ```

- **Reset local database (DESTRUCTIVE)**

  ```bash
  pnpm run db:reset
  ```

- **Regenerate test schema for PGlite**
  ```bash
  pnpm run test:_generate-schema
  ```

## Where Itâ€™s Used

- **`db:migrate`**: Used daily during local development and automatically in CI/CD for Preview and Production updates.
- **`db:reset`**: Used **locally only** when you need a clean slate (restarts Supabase, reapplies all migrations, seeds data).
- **`test:_generate-schema`**: Used after any schema change to keep PGlite integration tests in sync.

## Guidelines

- **Always migrations**: NEVER use `drizzle-kit push`. ALWAYS generate and apply migrations.
- **Descriptive names**: Use clear names for migrations (e.g., `add-notifications-table`).
- **Commit everything**: When you change the schema, commit `schema.ts`, the new `drizzle/` files, AND the updated `src/test/setup/schema.sql`.

## Safety Rules

- **Production/Preview**: NEVER run `db:reset` or `drizzle-kit push` on these environments. They must only ever be updated via `db:migrate`.
- **Destructive Action**: `db:reset` is local-only and will wipe all data in your local database. Use it with caution.
