# Phase 2.1: Fix PascalCase Database Table Names

## Overview
This phase fixes all remaining PascalCase database table names, index names, and enum names to use lowercase_underscore convention as required by Drizzle ORM after the Prisma migration.

**IMPORTANT**: The `scripts/setup-rls.sql` and `scripts/setup-rls.ts` files are being fixed by another agent - DO NOT modify these files.

## Prerequisites
- Ensure all tests are passing before starting (or note which are failing)
- Have a backup of your local database
- Close any running dev servers

## Step-by-Step Instructions

### STEP 1: Fix Schema Table Names

#### 1.1 Fix organizations.ts
**File**: `/var/home/froeht/Code/PinPoint/src/server/db/schema/organizations.ts`

**Line 63-78**: Change table name from `"rolePermissions"` to `"role_permissions"`

FIND:
```typescript
export const rolePermissions = pgTable(
  "rolePermissions",
```

REPLACE WITH:
```typescript
export const rolePermissions = pgTable(
  "role_permissions",
```

**Line 75-76**: Update index names

FIND:
```typescript
    index("_RolePermissions_roleId_idx").on(table.roleId),
    index("_RolePermissions_permissionId_idx").on(table.permissionId),
```

REPLACE WITH:
```typescript
    index("role_permissions_role_id_idx").on(table.roleId),
    index("role_permissions_permission_id_idx").on(table.permissionId),
```

#### 1.2 Fix issues.ts
**File**: `/var/home/froeht/Code/PinPoint/src/server/db/schema/issues.ts`

**Line 16**: Change enum name

FIND:
```typescript
export const statusCategoryEnum = pgEnum("StatusCategory", [
```

REPLACE WITH:
```typescript
export const statusCategoryEnum = pgEnum("status_category", [
```

**Line 22**: Change enum name

FIND:
```typescript
export const activityTypeEnum = pgEnum("ActivityType", [
```

REPLACE WITH:
```typescript
export const activityTypeEnum = pgEnum("activity_type", [
```

**Line 93**: Change table name

FIND:
```typescript
export const issueStatuses = pgTable(
  "issueStatuses",
```

REPLACE WITH:
```typescript
export const issueStatuses = pgTable(
  "issue_statuses",
```

**Line 150**: Change table name

FIND:
```typescript
export const issueHistory = pgTable(
  "issueHistory",
```

REPLACE WITH:
```typescript
export const issueHistory = pgTable(
  "issue_history",
```

#### 1.3 Fix collections.ts
**File**: `/var/home/froeht/Code/PinPoint/src/server/db/schema/collections.ts`

**Line 17**: Change enum name

FIND:
```typescript
export const notificationTypeEnum = pgEnum("NotificationType", [
```

REPLACE WITH:
```typescript
export const notificationTypeEnum = pgEnum("notification_type", [
```

**Line 26**: Change enum name

FIND:
```typescript
export const notificationEntityEnum = pgEnum("NotificationEntity", [
```

REPLACE WITH:
```typescript
export const notificationEntityEnum = pgEnum("notification_entity", [
```

**Line 62**: Change table name

FIND:
```typescript
export const collectionTypes = pgTable(
  "collectionTypes",
```

REPLACE WITH:
```typescript
export const collectionTypes = pgTable(
  "collection_types",
```

### STEP 2: Fix All Index Names

Run these replacements in ALL schema files (`organizations.ts`, `issues.ts`, `collections.ts`, `machines.ts`):

**Use Find & Replace with Regular Expressions ENABLED**:

Pattern 1: Organization indexes
- FIND: `index\("Organization_`
- REPLACE: `index("organizations_`

Pattern 2: Membership indexes  
- FIND: `index\("Membership_`
- REPLACE: `index("memberships_`

Pattern 3: Role indexes
- FIND: `index\("Role_`
- REPLACE: `index("roles_`

Pattern 4: Machine indexes
- FIND: `index\("Machine_`
- REPLACE: `index("machines_`

Pattern 5: Issue indexes
- FIND: `index\("Issue_`
- REPLACE: `index("issues_`

Pattern 6: Priority indexes
- FIND: `index\("Priority_`
- REPLACE: `index("priorities_`

Pattern 7: IssueStatus indexes
- FIND: `index\("IssueStatus_`
- REPLACE: `index("issue_statuses_`

Pattern 8: Attachment indexes
- FIND: `index\("Attachment_`
- REPLACE: `index("attachments_`

Pattern 9: IssueHistory indexes
- FIND: `index\("IssueHistory_`
- REPLACE: `index("issue_history_`

Pattern 10: Upvote indexes
- FIND: `index\("Upvote_`
- REPLACE: `index("upvotes_`

Pattern 11: Collection indexes
- FIND: `index\("Collection_`
- REPLACE: `index("collections_`

Pattern 12: CollectionType indexes
- FIND: `index\("CollectionType_`
- REPLACE: `index("collection_types_`

### STEP 3: Fix Service Files

#### 3.1 Fix roleService.ts
**File**: `/var/home/froeht/Code/PinPoint/src/server/services/roleService.ts`

Search for `rolePermissions` and replace with `role_permissions` ONLY in SQL strings and table references.

#### 3.2 Fix issueActivityService.ts  
**File**: `/var/home/froeht/Code/PinPoint/src/server/services/issueActivityService.ts`

Search for:
- `issueHistory` → `issue_history` (in SQL strings)
- `issueStatuses` → `issue_statuses` (in SQL strings)

#### 3.3 Fix collectionService.ts
**File**: `/var/home/froeht/Code/PinPoint/src/server/services/collectionService.ts`

Search for:
- `collectionTypes` → `collection_types` (in SQL strings)
- Verify `collection_machines` is already correct

#### 3.4 Fix pinballmapService.ts
**File**: `/var/home/froeht/Code/PinPoint/src/server/services/pinballmapService.ts`

Search for `pinballMapConfigs` and replace with `pinball_map_configs` (in SQL strings)

### STEP 4: Fix SQL Files

#### 4.1 Fix seed.sql
**File**: `/var/home/froeht/Code/PinPoint/supabase/seed.sql`

**Line 32**: Change User table reference

FIND:
```sql
  INSERT INTO public."User" (
```

REPLACE WITH:
```sql
  INSERT INTO public.users (
```

Search entire file for any other `"User"` references and replace with `users`.

### STEP 5: Fix Test Files

Search in ALL test files (`**/*.test.ts`, `**/*.integration.test.ts`) for:

1. String literals with PascalCase table names:
   - `"rolePermissions"` → `"role_permissions"`
   - `"issueStatuses"` → `"issue_statuses"`
   - `"issueHistory"` → `"issue_history"`
   - `"collectionTypes"` → `"collection_types"`
   - `"pinballMapConfigs"` → `"pinball_map_configs"`

2. Mock data and test factories may reference these names

### STEP 6: Update Documentation

#### Files to check and update:
1. `/var/home/froeht/Code/PinPoint/docs/developer-guides/drizzle/schema-patterns.md`
2. `/var/home/froeht/Code/PinPoint/docs/developer-guides/drizzle/query-patterns.md`
3. `/var/home/froeht/Code/PinPoint/docs/testing/drizzle-router-testing-guide.md`
4. `/var/home/froeht/Code/PinPoint/migration-plan-v2/*.md` files

Replace all PascalCase table references with lowercase_underscore versions.

## Validation Checklist

After completing all changes, run these commands IN ORDER:

1. **TypeScript compilation check**:
   ```bash
   npm run typecheck:brief
   ```
   If errors, fix them before proceeding.

2. **Check for remaining PascalCase patterns**:
   ```bash
   # Check for PascalCase table names in TypeScript files
   rg '"(rolePermissions|issueStatuses|issueHistory|collectionTypes|pinballMapConfigs)"' --type ts
   
   # Check for PascalCase index names
   rg 'index\("[A-Z][a-zA-Z]+_' --type ts
   
   # Check for PascalCase enum names
   rg 'pgEnum\("[A-Z]' --type ts
   ```
   These should return NO results (except in node_modules).

3. **Run tests** (may have pre-existing failures):
   ```bash
   npm run test:brief
   ```
   Note any NEW failures that weren't present before.

4. **Verify database schema** (if you have local database running):
   ```bash
   # This will show if table names are correct in the database
   npm run db:push:local
   ```

## Common Issues & Solutions

### Issue: TypeScript errors after renaming
**Solution**: The variable names (like `rolePermissions`) stay the same - only change the string table name inside `pgTable()`.

### Issue: Tests failing with "relation does not exist"
**Solution**: You may need to run database migrations or reset your local database after these changes.

### Issue: Import errors
**Solution**: Do NOT change import statements or exported variable names, only the table name strings.

## Files Modified Summary

**Schema Files** (7 files):
- src/server/db/schema/organizations.ts
- src/server/db/schema/issues.ts  
- src/server/db/schema/collections.ts
- src/server/db/schema/machines.ts
- src/server/db/schema/auth.ts (check for any indexes)
- src/server/db/schema/index.ts (may need updates if table names are referenced)

**Service Files** (at least 4):
- src/server/services/roleService.ts
- src/server/services/issueActivityService.ts
- src/server/services/collectionService.ts
- src/server/services/pinballmapService.ts

**SQL Files** (1):
- supabase/seed.sql

**Test Files**: Multiple files in src/test/ and src/server/ directories

**Documentation**: Multiple .md files

## Final Notes

- This is primarily a find-and-replace operation
- Variable names DO NOT change, only database table/index/enum names
- If unsure about a change, check if it's inside a string literal
- The setup-rls files are handled separately - DO NOT touch them
- After completion, ALL database object names should be lowercase_underscore