# Migration Setup: Infrastructure & Workflow Foundation

**Purpose**: Essential infrastructure setup before beginning Phase 1  
**Context**: Worktree-based workflow with custom migration tooling  
**Prerequisite**: Must complete before any architectural work begins  
**Duration**: 1-2 hours setup, then seamless daily workflow

---

## 🏗️ Migration Infrastructure Requirements

### **Git Worktree Strategy**

**Why Worktrees**: Keep main repo clean while working on migration phases in parallel

```bash
# Setup worktree structure
git worktree add ../pinpoint-phase-1 migration-phase-1
git worktree add ../pinpoint-phase-2 migration-phase-2
git worktree add ../pinpoint-phase-2.5 migration-phase-2.5
git worktree add ../pinpoint-phase-3 migration-phase-3
git worktree add ../pinpoint-phase-4 migration-phase-4

# Work in separate directories, same repo
cd ../pinpoint-phase-1  # Work on Prisma removal
cd ../pinpoint-phase-2  # Work on RLS implementation
# etc.
```

**Daily Workflow**:

```bash
# Start work session
cd ../pinpoint-phase-N
git status
npm run validate-migration-phase

# End work session
git add -A
git commit -m "Phase N progress: [specific achievements]"
git push origin migration-phase-N
```

### **Required NPM Scripts Creation**

**Problem**: Execution framework assumes scripts that don't exist  
**Solution**: Add migration-specific scripts to package.json

```bash
# Add these scripts to package.json
npm pkg set scripts.validate-migration-phase="node scripts/validate-migration-phase.cjs"
npm pkg set scripts.test:rls-basic="vitest run --testNamePattern='basic.*RLS|RLS.*basic'"
npm pkg set scripts.test:rls-crud="vitest run --testNamePattern='RLS.*CRUD'"
npm pkg set scripts.test:security="vitest run --testNamePattern='security|RLS policy'"
npm pkg set scripts.test:performance="vitest run --testNamePattern='performance|benchmark'"
npm pkg set scripts.test:count="vitest run --reporter=json | jq '.numTotalTests'"
npm pkg set scripts.test:memory-check="node scripts/memory-usage-check.cjs"
npm pkg set scripts.test:archetype-examples="vitest run src/test/examples/"
```

### **Migration Script Creation**

**Create validation script**:

```bash
# scripts/validate-migration-phase.cjs
#!/usr/bin/env node

const { execSync } = require('child_process');
const fs = require('fs');

const currentBranch = execSync('git branch --show-current', { encoding: 'utf8' }).trim();
const phase = currentBranch.match(/phase-(\d+(?:\.\d+)?)/)?.[1];

console.log(`🔍 Validating Phase ${phase} dependencies...`);

switch(phase) {
  case '1':
    // Check Prisma removal progress
    try {
      const prismaRefs = execSync('rg -c "prisma" src/ || echo "0"', { encoding: 'utf8' }).trim();
      console.log(`📦 Prisma references remaining: ${prismaRefs}`);

      execSync('npm run typecheck:brief', { stdio: 'inherit' });
      console.log('✅ Phase 1 validation passed');
    } catch (error) {
      console.log('❌ Phase 1 validation failed');
      process.exit(1);
    }
    break;

  case '2':
    // Check RLS implementation
    console.log('🔐 Validating RLS implementation...');
    // Add RLS-specific checks here
    console.log('✅ Phase 2 validation passed');
    break;

  default:
    console.log(`📋 Phase ${phase} - using general validation`);
    execSync('npm run validate', { stdio: 'inherit' });
}
```

**Create memory check script**:

```bash
# scripts/memory-usage-check.cjs
#!/usr/bin/env node

console.log('💾 Checking test memory usage patterns...');

const { execSync } = require('child_process');

// Check for memory-unsafe patterns
try {
  const unsafePatterns = execSync('rg -c "new PGlite\\(" src/ || echo "0"', { encoding: 'utf8' }).trim();

  if (parseInt(unsafePatterns) > 0) {
    console.log(`❌ Found ${unsafePatterns} unsafe PGlite instantiations`);
    console.log('Use worker-scoped pattern instead');
    process.exit(1);
  }

  console.log('✅ Memory usage patterns are safe');
} catch (error) {
  console.log('⚠️  Could not check memory patterns');
}
```

---

## 📋 Setup Checklist

### **Pre-Migration Setup** (Complete Once)

**Infrastructure Setup**:

- [ ] Create git worktrees for each phase
- [ ] Add migration-specific npm scripts
- [ ] Create validation scripts in scripts/ directory
- [ ] Test script functionality
- [ ] Create checkpoint backup branch

**Validation**:

```bash
# Test setup works
npm run validate-migration-phase  # Should run without errors
npm run test:brief                # Should show current test status
git worktree list                 # Should show all phase worktrees
```

### **Daily Session Setup** (Each Work Session)

**Session Start**:

- [ ] Navigate to appropriate phase worktree
- [ ] Run `npm run validate-migration-phase`
- [ ] Review yesterday's progress: `git log --oneline -5`
- [ ] Set session goal for current phase only

**Session End**:

- [ ] Commit progress with descriptive message
- [ ] Push to phase branch: `git push origin migration-phase-N`
- [ ] Note any blockers or insights for next session

### **Phase Transition Setup** (Between Phases)

**Phase Completion**:

- [ ] Run final validation: `npm run validate-migration-phase`
- [ ] Create completion tag: `git tag phase-N-complete`
- [ ] Document phase completion in progress log

**Phase Handoff**:

- [ ] Switch to next phase worktree
- [ ] Verify dependencies satisfied from previous phase
- [ ] Begin next phase with clean workspace

---

## 🔧 Troubleshooting Setup Issues

### **Common Setup Problems**

**Worktree Creation Fails**:

```bash
# If branch doesn't exist, create it first
git checkout -b migration-phase-N
git push -u origin migration-phase-N
git worktree add ../pinpoint-phase-N migration-phase-N
```

**Script Creation Fails**:

```bash
# Manual script addition if npm pkg doesn't work
# Edit package.json directly and add scripts
```

**Validation Script Errors**:

```bash
# Ensure dependencies exist
npm install -g jq  # For JSON processing
# Ensure ripgrep (rg) is available
```

### **Script Dependencies**

**Required Tools**:

- `jq` - JSON processing for test counting
- `rg` (ripgrep) - Fast text searching
- `node` - Script execution
- `git` - Version control operations

**Installation**:

```bash
# macOS
brew install jq ripgrep

# Linux
sudo apt install jq ripgrep
```

---

## 🎯 Setup Success Criteria

### **Infrastructure Ready When**:

- [ ] All worktrees created and accessible
- [ ] All npm scripts execute without errors
- [ ] Validation scripts provide meaningful output
- [ ] Daily workflow procedures tested

### **Workflow Ready When**:

- [ ] Can switch between phase worktrees seamlessly
- [ ] Can validate current phase status instantly
- [ ] Can commit and push changes to phase branches
- [ ] Can track progress across phases

### **Ready for Phase 1 When**:

- [ ] Setup checklist 100% complete
- [ ] `npm run validate-migration-phase` passes
- [ ] Team understands worktree workflow
- [ ] All tools and dependencies installed

---

## 🚀 Migration Launch Command

```bash
# Final setup validation and Phase 1 launch
npm run validate-migration-phase && \
cd ../pinpoint-phase-1 && \
echo "🎯 Migration infrastructure ready!" && \
echo "📦 Beginning Phase 1: Prisma Removal" && \
echo "See 01-phase1-prisma-removal.md for execution plan"
```

---

**Next Step**: With infrastructure setup complete, proceed to [Phase 1: Prisma Removal](./01-phase1-prisma-removal.md) using the established worktree workflow.
