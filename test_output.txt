
> pinpoint@0.2.0 test:integration
> vitest run --project integration --silent --no-color src/test/integration/admin/user-management.test.ts


 RUN  v4.0.12 /home/froeht/Code/PinPoint-AntiGravity

 ❯ |integration| src/test/integration/admin/user-management.test.ts (3 tests | 3 skipped) 14ms
     ↓ should allow admin to change user role
     ↓ should prevent admin from demoting themselves
     ↓ should prevent non-admin from changing roles

⎯⎯⎯⎯⎯⎯ Failed Suites 1 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  |integration| src/test/integration/admin/user-management.test.ts > Admin User Management Integration
Error: Failed query: insert into "user_profiles" ("id", "first_name", "last_name", "avatar_url", "role", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7)
params: 2dc2ad97-6273-4e38-afa8-53c71eca189d,Admin,User,,admin,2025-12-05T19:20:24.146Z,2025-12-05T19:20:24.146Z
 ❯ PostgresJsPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 ❯ src/test/integration/admin/user-management.test.ts:57:5
     55|     // Remove avatarUrl if null to avoid type issues if factory return…
     56|     // Actually factory matches schema.
     57|     await db.insert(userProfiles).values(adminProfileData);
       |     ^
     58| 
     59|     adminUser = { id: adminId, email: adminEmail };

Caused by: PostgresError: duplicate key value violates unique constraint "user_profiles_pkey"
 ❯ ErrorResponse node_modules/postgres/src/connection.js:794:26
 ❯ handle node_modules/postgres/src/connection.js:480:6
 ❯ Socket.data node_modules/postgres/src/connection.js:315:9

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯
Serialized Error: { severity_local: 'ERROR', severity: 'ERROR', code: '23505', detail: 'Key (id)=(2dc2ad97-6273-4e38-afa8-53c71eca189d) already exists.', schema_name: 'public', table_name: 'user_profiles', constraint_name: 'user_profiles_pkey', file: 'nbtinsert.c', routine: '_bt_check_unique', query: 'insert into "user_profiles" ("id", "first_name", "last_name", "avatar_url", "role", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7)', parameters: [ '2dc2ad97-6273-4e38-afa8-53c71eca189d', 'Admin', 'User', null, 'admin', '2025-12-05T19:20:24.146Z', '2025-12-05T19:20:24.146Z' ], args: [ '2dc2ad97-6273-4e38-afa8-53c71eca189d', 'Admin', 'User', null, 'admin', '2025-12-05T19:20:24.146Z', '2025-12-05T19:20:24.146Z' ], types: [ 2950, 25, 25, 25, 25, 1184, 1184 ] }
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/1]⎯


 Test Files  1 failed (1)
      Tests  3 skipped (3)
   Start at  13:20:23
   Duration  267ms (transform 36ms, setup 29ms, collect 176ms, tests 14ms, environment 0ms, prepare 3ms)

